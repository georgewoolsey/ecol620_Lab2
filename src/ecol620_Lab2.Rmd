---
title: "Lab 2"
subtitle: "ECOL 620 - Applications in Landscape Ecology"
author: "George Woolsey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    # code_folding: hide
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding){ 
    out_dir <- '../';
    rmarkdown::render(inputFile, encoding = encoding, output_file=file.path(dirname(inputFile), out_dir, 'index.html'));
    rmarkdown::render(inputFile, encoding = encoding, output_file=file.path(dirname(inputFile), out_dir, '/data/lab2_george_woolsey.html')) 
  })
---

# Setup

```{r, include=FALSE, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  # , results='hide'
  , fig.width = 10
  , fig.height = 7
)
```

```{r, eval=T}
# bread-and-butter
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)
# visualization
library(ggrepel)
library(cowplot)
library(kableExtra)
# spatial analysis
library(USAboundaries)
library(sf)
library(terra)
```


# Rules

1. Using the provided R Markdown template, answer all questions and show your R code where necessary. Note, some questions are just plain text written answers.
2. Complete your assignment using the R markdown file and submit individual assignments to Canvas. Knit your script and submit an .html file on Canvas. Please use  the following naming convention: lab2_firstname_lastname.html (ex. lab2_kyle_horton.html).  Note, we will not grade labs in any other format.

## Question 1

Briefly describe (1-2 sentences) what each of the following functions achieve. All of these functions are seen throughout the Lab #2 example code. Use complete sentences (1 pt each). 

* `crop()` is from the `terra` package and is used to cut out a part of a raster based on another object or defined extent.
* `ext()` is from the `terra` package and is used to return or create the extent of a raster.
* `disagg()` - going from coarse to fine on raster, enhance the resolution (can do this by making all the same or use interpolation [e.g. distance weighted interpolation])
* `aggregate()` is from the `terra` package and is used to create a new raster with a lower spatial resolution (e.g. coarser grain size) by applying an aggregate function (e.g. mean).
* `global()` is from the `terra` package and is used to calculate summarized values (e.g. mean, sum) of the entire raster extent.
* `mask()` is from the `terra` package and is used to update the values of a raster to `NA` for specified cells (e.g. from a separate mask raster).
* `res()` is from the `terra` package and is used to get the resolution of a raster in terms of the grain (e.g. 30m$\times$30m).
* `st_buffer()` is from the `sf` package and is used to compute a buffer of a defined distance around a geometry.
* `rpois()` is used to draw a sample of $n$ from the Poisson distribution with parameter $\lambda$. 

# Question 2 
Create a 15 by 15 raster using the Poisson distribution to randomly draw the values. Design the raster to have a mean and variance of 5 (approximately). Generate a figure of the raster with cell values labeled (e.g., follow the aesthetic of Figure 2.5a, although with color). Include code to generate the raster and figure. For this example, use the supplied raster plotting code (don’t worry about ggplot, yet). Report the mean and variance of the newly generated raster. (3 pts)

```{r}
# generate raster
raster_size <- 15
raster_temp <- terra::rast(ncol = raster_size, nrow = raster_size, xmin = 0, xmax = raster_size, ymin = 0, ymax = raster_size)
# fill raster with random values
raster_temp[] <- rpois(n = terra::ncell(raster_temp), lambda = 5)
# plot raster
  # and report the mean and variance
raster_temp %>% as.data.frame(xy = TRUE) %>% 
  ggplot(.) +
    geom_raster(
      mapping = aes(x = x, y = y, fill = lyr.1)
    ) +
    geom_text(
      mapping = aes(x = x, y = y, label = lyr.1)
      , color = "white"
    ) +
    scale_fill_viridis_c(option = "viridis") +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    labs(
      title = "15x15 raster with values drawn from the Poisson distribution"
      , subtitle = paste0(
        "Mean: "
        , terra::global(raster_temp, fun = "mean")[[1]] %>% scales::comma(accuracy = .01)
        , ", Variance: "
        , terra::global(raster_temp, fun = "sd")[[1]]^2 %>% scales::comma(accuracy = .01)
      )
    ) +
    theme_bw() +
    theme(
      legend.position = "none"
    )
```

Based on the example raster created from random values drawn from a Poisson distribution with $\lambda = 5$, the mean cell value is **`r terra::global(raster_temp, fun = "mean")[[1]] %>% scales::comma(accuracy = .01)`** and the variance of the entire raster extent is is **`r terra::global(raster_temp, fun = "sd")[[1]]^2 %>% scales::comma(accuracy = .01)`**.

# Question 3

Within the “elevation” folder, there is a digital elevation raster of the southern Colorado areaAggregate (using the mean) the elevation raster by factors of 5, 30, 55, 80, …255 (i.e., by increments of 25). Plot the spatial grain versus spatial variance, using a log scale. Note, global won't calculate `var`, but will calculate `sd`. Describe the relationship between the two variables. (10 pts)


```{r}
#Hint for plotting:
#ggplot()+
#  geom_point()+
#  theme_classic()+
#  labs(y = "Log(spatial variance)", x = "Log( grain)")
```


## Question 4
Include a plot of the elevation raster aggregated by a factor of 55 using ggplot. Please include a state overlay (see code from Lab #1 for state data, `states_map <- map_data("state")`). If you use a projection, ggplot will take longer to process the image. Re-projecting the data is not necessary for this exercise. (8 pts) 


```{r}
#Hint: Use the following lines of code to format the raster. 
#SRTM_df <- as.data.frame(SRTM_df, xy=T); #ggplot doesn’t handle rasters that well. Convert to a dataframe
#colnames(SRTM_df) <- c("X","Y","DEM")
#head(SRTM_df)
```


```{r}
#Plotting code
#ggplot(don’t insert anything here)+
#  geom_raster(data=insert the elevation dataframe information, aes(x=?, y=?, fill=?))+
#  scale_fill_gradientn(insert a color scale)+
#  geom_polygon(insert the state polygon information)+
#  coord_cartesian(insert the extent of the elevation raster)+
#  theme_classic(don’t insert anything here)+
#  labs(y = "Latitude", x = "Longitude")
```

# Five-lined Skink Data (multi-scale analysis)


## Question 5
Once you have cropped raster “nlcd” using a 10km barrier from the min and max coordinates of the reptile sampling locations (Lines 245-249), how many cells remain? What percent reduction did you see from the original raster?  (3 pts)

```{r}

```


## Question 6
Using intervals of 500 m and a maximum range of 5000 m (minimum range of 500 m), where do you see the greatest correlation in each pairwise combination of scales? Is this surprising? Plot the scatter plot of the greatest pair-wise correlation combination. See Figure 2.9 for an example of many similar pairwise plots. (5 pts)


```{r}
#Hint:
#ggplot()+
#  geom_point()+
#  theme_classic()+
#  labs(y = "Forest cover surrounding sample location at XXkm (%)", x = "Forest cover surrounding sample   location at XXkm (%))")
```

## Question 7
Generate Figure 2.11 (only panels a and b) using ggplot. Use 500 m intervals and a maximum range of 5000 m (minimum range of 500 m). What does this suggest about the scale of drivers of occurrence for five-lined skinks? Where is the strongest association? How does your conclusion differ (or not) from the results of Fletcher and Fortin? Do you believe the scale of effect has been captured by the scales sampled? Be sure to add appropriate labels. (12 pts) 


```{r}
#Hint (for the beta plot):
#ggplot()+
#  geom_point(data=XX_data, aes(x=XX_size, y=XX_coef))+
#  geom_errorbar(data=buffer_data, aes(x=XX,ymin=XX, ymax=XX), colour="black", width=.1)
```






